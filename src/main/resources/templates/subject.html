<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Danh s√°ch m√¥n</title>
  <link rel="stylesheet" href="/css/common.css">
  <link rel="stylesheet" href="/css/subject.css">

</head>

<body>
<header>
  <a href="/home" class="logo">
    <h1>Thi<span>Tot</span></h1>
  </a>
  <nav class="menu">
    <ul>
      <li><a href="/profile">Th√¥ng tin c√° nh√¢n</a></li>
      <li><a href="/exam">ƒê·ªÅ thi</a></li>
      <li><a href="/subject">Luy·ªán t·∫≠p</a></li>
      <li><a href="/history">L·ªãch s·ª≠ thi</a></li>
      <li th:if="${user != null}"><a href="/logout">ƒêƒÉng xu·∫•t</a></li>
      <li th:unless="${user != null}"><a href="/login">ƒêƒÉng nh·∫≠p</a></li>
    </ul>
  </nav>
</header>

<main>
  <div class="header-row">
    <h2>Danh s√°ch m√¥n</h2>
    <div class="search-bar">
      <input type="text" id="searchInput" placeholder="T√¨m ki·∫øm m√¥n h·ªçc...">
      <button id="searchBtn">üîç</button>
    </div>
  </div>

  <div class="subject-container" id="subjectList">
    <!-- Thymeleaf loop -->
    <div class="subject-card" th:each="sub : ${subjects}">
      <p class="subject-title" th:text="${sub.subjectName}">T√™n m√¥n</p>

      <img class="subject-img"
           th:src="${sub.imageUrl}"
           alt="·∫¢nh m√¥n h·ªçc">

      <p class="subject-desc" th:text="${sub.description}">M√¥ t·∫£ m√¥n</p>

      <div class="button-group">
        <button class="btn btn-outline"
                th:attr="data-name=${sub.subjectName}, data-desc=${sub.description}"
                onclick="showDetails(this)">
          Chi ti·∫øt
        </button>

        <!-- ‚úÖ th√™m data-id -->
        <button class="btn btn-primary"
                th:attr="data-id=${sub.subjectId}, data-name=${sub.subjectName}"
                onclick="openExam(this)">
          V√†o thi
        </button>
      </div>
    </div>
  </div>
</main>

<footer>¬© 2025 ThiTot - N·ªÅn t·∫£ng thi tr·∫Øc nghi·ªám</footer>

<!-- Popup V√†o thi -->
<div class="overlay" id="popupExam">
  <div class="popup">
    <button class="close-btn" onclick="closePopup('popupExam')">‚úñ</button>
    <h3>V√†o Thi</h3>

    <!-- ·∫®n ID m√¥n thi -->
    <input type="hidden" id="subjectId">

    <label>M√¥n thi</label>
    <input id="subjectName" readonly>

    <label>ƒê·ªô kh√≥</label>
    <select id="difficulty">
      <option value="D·ªÖ">D·ªÖ</option>
      <option value="Trung b√¨nh">Trung b√¨nh</option>
      <option value="Kh√≥">Kh√≥</option>
    </select>

    <label>S·ªë l∆∞·ª£ng c√¢u h·ªèi</label>
    <input id="questionCount" readonly>

    <button class="submit" onclick="submitExam()">V√†o thi</button>
  </div>
</div>

<!-- Popup Chi ti·∫øt -->
<div class="overlay" id="popupDetails">
  <div class="popup popup-details">
    <button class="close-btn" onclick="closePopup('popupDetails')">‚úñ</button>
    <h3>Chi ti·∫øt m√¥n h·ªçc</h3>

    <p><strong>T√™n m√¥n:</strong> <span id="detailName"></span></p>
    <p><strong>M√¥ t·∫£:</strong> <span id="detailDesc"></span></p>

    <table class="difficulty-table">
      <thead>
      <tr>
        <th>ƒê·ªô kh√≥</th>
        <th>S·ªë l∆∞·ª£ng c√¢u h·ªèi</th>
        <th>Th·ªùi gian l√†m b√†i</th>
      </tr>
      </thead>
      <tbody>
      <tr>
        <td>D·ªÖ</td>
        <td>40 c√¢u</td>
        <td>60 ph√∫t</td>
      </tr>
      <tr>
        <td>Trung b√¨nh</td>
        <td>50 c√¢u</td>
        <td>90 ph√∫t</td>
      </tr>
      <tr>
        <td>Kh√≥</td>
        <td>60 c√¢u</td>
        <td>120 ph√∫t</td>
      </tr>
      </tbody>
    </table>
  </div>
</div>

<script>
  // ----- T√¨m ki·∫øm -----
  const searchInput = document.getElementById("searchInput");
  const searchBtn = document.getElementById("searchBtn");
  const subjectList = document.getElementById("subjectList");
  const subjectCards = Array.from(document.querySelectorAll(".subject-card"));

  const noDataDiv = document.createElement("div");
  noDataDiv.textContent = "Kh√¥ng c√≥ d·ªØ li·ªáu ph√π h·ª£p";
  noDataDiv.style.textAlign = "center";
  noDataDiv.style.fontSize = "18px";
  noDataDiv.style.color = "#666";
  noDataDiv.style.padding = "40px 0";
  noDataDiv.style.display = "none";
  subjectList.appendChild(noDataDiv);

  function searchSubjects() {
    const keyword = searchInput.value.trim().toLowerCase();
    let visibleCount = 0;

    subjectCards.forEach(card => {
      const title = card.querySelector(".subject-title").innerText.toLowerCase();
      const match = title.includes(keyword);
      card.style.display = match ? "block" : "none";
      if (match) visibleCount++;
    });

    noDataDiv.style.display = visibleCount === 0 ? "block" : "none";
  }

  searchBtn.addEventListener("click", searchSubjects);
  searchInput.addEventListener("input", searchSubjects);

  // ----- Popup Chi ti·∫øt -----
  function showDetails(btn) {
    document.getElementById('detailName').innerText = btn.getAttribute('data-name');
    document.getElementById('detailDesc').innerText = btn.getAttribute('data-desc');
    document.getElementById('popupDetails').classList.add('active');
  }

  // ----- Popup V√†o thi -----
  const difficultySelect = document.getElementById("difficulty");
  const questionCountInput = document.getElementById("questionCount");

  function openExam(btn) {
    document.getElementById('subjectId').value = btn.getAttribute('data-id');
    document.getElementById('subjectName').value = btn.getAttribute('data-name');
    difficultySelect.value = "D·ªÖ";
    questionCountInput.value = "40";
    document.getElementById('popupExam').classList.add('active');
  }

  function closePopup(id) {
    document.getElementById(id).classList.remove('active');
  }

  difficultySelect.addEventListener("change", () => {
    switch (difficultySelect.value) {
      case "D·ªÖ":
        questionCountInput.value = "40";
        break;
      case "Trung b√¨nh":
        questionCountInput.value = "50";
        break;
      case "Kh√≥":
        questionCountInput.value = "60";
        break;
    }
  });

  // ----- Khi ·∫•n ‚ÄúV√†o thi‚Äù -----
  function submitExam() {
    const subjectId = document.getElementById('subjectId').value;
    const difficulty = document.getElementById('difficulty').value;
    const questionCount = document.getElementById('questionCount').value;

    if (!subjectId) {
      alert("Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c m√¥n thi!");
      return;
    }

    // ‚úÖ Chuy·ªÉn h∆∞·ªõng ƒë√∫ng format cho controller
    const url = `/start?subjectId=${subjectId}&difficulty=${encodeURIComponent(difficulty)}&count=${encodeURIComponent(questionCount)}`;
    window.location.href = url;
  }
</script>

</body>
</html>
